{% extends 'PlanillasEstructuraBundle::layout.html.twig' %}

{% block content_content %}

    <div class="row">
        <div id="event-messages" class="col-sm-12">

        </div>
    </div>

    <ul id="hierarchical-structure" class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#empresa">Empresas</a></li>
        <li><a data-toggle="tab" href="#cliente">Clientes</a></li>
        <li><a data-toggle="tab" href="#sucursal">Sucursales</a></li>
        <li><a data-toggle="tab" href="#turno">Turnos</a></li>
        <li><a data-toggle="tab" href="#puesto">Puestos</a></li>
    </ul>
    <div id="hierarchical-content" class="tab-content">
        <div id="empresa" class="tab-pane fade in active">{% render path('estructura_empresa_index') %}</div>
        <div id="cliente" class="tab-pane fade">{% render path('estructura_cliente_index') %}</div>
        <div id="sucursal" class="tab-pane fade">{% include '@PlanillasEstructura/Sucursal/index.html.twig' %}</div>
        <div id="turno" class="tab-pane fade">{% include '@PlanillasEstructura/Turno/index.html.twig' %}</div>
        <div id="puesto" class="tab-pane fade">{% include '@PlanillasEstructura/Puesto/index.html.twig' %}</div>
    </div>
{% endblock content_content %}

{% block javascripts %}
    <script type="text/javascript">
        $(document).ready(function () {
            var alert_error = '<div class="alert alert-danger">__message__<div>';
            var alert_success = '<div class="alert alert-success">__message__<div>';
            var help_block = '<span class="help-block">__message__ <br></span>'
            var progress_bar = '<div class="progress progress-striped active"><div class="progress-bar" style="width: 100%;"></div></div>';
            var $actual_process = "empresa";

            bind_events ();

            $('a.btn.btn-primary.submit-button').on('click', function (e) {
                e.preventDefault();
                var type = $(this).data('content');

                switch (type) {
                    case 'empresa':
                        submit_empresa();
                        break;
                    case 'cliente':
                        submit_cliente();
                        break;
                }
            });

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var value = $(e.target).attr('href');
                value = value.substring(1,value.length);
                //console.log(value);
                $actual_process = value;
            });



            function submit_empresa () {
                var data = $('form#empresa-form').serialize();
                $.ajax({
                    'url': Routing.generate('estructura_empresa_create'),
                    'data': data,
                    'type': "POST",
                    'dataType': "HTML"
                })
                .done(function (response) {
                    var message = response;
                    var alert = transform2JQueryObject(message, alert_success);
                    appendAlertMessage(alert);
                    cleanFormErrors('planillas_estructurabundle_empresa_');

                    $.ajax({
                        'url': Routing.generate('estructura_empresa_list'),
                        'type': 'GET'
                    })
                    .done(function (htmltable) {
                        $('div#empresa-body').html(htmltable);
                    });
                })
                .fail(function (error) {
                    var errors = JSON.parse(error.responseText);

                    var alert = transform2JQueryObject("Ha ocurrido un error creando la Empresa.",alert_error);
                    appendAlertMessage(alert);

                    proccessErrors(errors, 'input#planillas_estructurabundle_empresa_');

                })
                .always();
            }

            function submit_cliente () {
                var data = $('form#cliente-form').serialize();
                $.ajax({
                    'url': Routing.generate('estructura_cliente_create'),
                    'data': data,
                    'type': "POST",
                    'dataType': "HTML"
                })
                        .done(function (response) {
                            var message = response;
                            var alert = transform2JQueryObject(message, alert_success);
                            appendAlertMessage(alert);
                            cleanFormErrors('planillas_estructurabundle_cliente_');

                            $.ajax({
                                'url': Routing.generate('estructura_cliente_list'),
                                'type': 'GET'
                            })
                                    .done(function (htmltable) {
                                        $('div#cliente-body').html(htmltable);
                                    });
                        })
                        .fail(function (error) {
                            var errors = JSON.parse(error.responseText);

                            var alert = transform2JQueryObject("Ha ocurrido un error creando el Cliente.", alert_error);
                            appendAlertMessage(alert);

                            proccessErrors(errors, 'input#planillas_estructurabundle_cliente_');

                        })
                        .always();
            }

            function transform2JQueryObject (message,template) {
                var object = template.replace(/__message__/g, message);
                return $(object);
            }

            function proccessErrors (errors, inputId) {
                $.each(errors, function (key, errors) {
                    if (isNaN(key)) {
                        if (key =="error") {
                            $.each(errors, function (k, value) {
                                var alert = alert_error.replace(/__message__/g, value);
                                appendAlertMessage(alert);
                            });
                        } else {
                            var input = $(inputId + key);
                            input.parent().parent().addClass('has-error');

                            $.each(errors, function (k, value) {
                                input.parent().append(transform2JQueryObject(value, help_block));
                            });
                        }
                    } else {
                        var alert = alert_error.replace(/__message__/g, value);
                        appendAlertMessage(alert);
                    }
                });
            }

            function appendAlertMessage(alert) {
                alert = $(alert).delay(4000).hide(500);
                $('div#event-messages').append(alert);
            }

            function cleanFormErrors (formname) {
                $('input[id^=' + formname + ']').each(function (key, element) {
                    $(element).parent().parent().removeClass('has-error');
                    $(element).parent().find('span.help-block').remove();
                    $(element).val('');
                });
                $('select[id^=' + formname + ']').each(function (key, element) {
                    $(element).parent().parent().removeClass('has-error');
                    $(element).parent().find('span.help-block').remove();
                });
            }

            function bind_events () {
                $('ul.pagination a').on('click', function (e) {
                    e.preventDefault();
                    load_page($(this));
                });
            }

            function load_page(element) {
                var route = $(element).attr('href');
                var params = route.split("?");
                var page = -1;
                for (var i=0; i < params.length; i++) {
                    if (params[i].indexOf("page") >= 0) {
                        var split = params[i].split("&");
                        for (var j=0; j < split.length; j++) {
                            if (split[j].indexOf("page") == 0) {
                                var page_var = split[j].split("=");
                                page = page_var[1];
                                break;
                            }
                        }
                    }
                }

                var data;
                if(page != -1) {
                    data = {'page':page};
                    $('div#' + $actual_process +'-body').html(progress_bar);
                } else {
                    data = {};
                }

                var element;

                $.ajax({
                    'url': Routing.generate('estructura_' + $actual_process + '_list'),
                    'data' : data,
                    'type': 'GET'
                })
                .done(function (htmltable) {
                    $('div#' + $actual_process +'-body').html(htmltable);
                    bind_events ();
                })
                .always(function () {
                });
            }
        });
    </script>
{% endblock javascripts %}